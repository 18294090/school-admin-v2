{% extends "base.html" %}
{% block title %}<title>{{class_.class_name}} 学生作业情况</title>{% endblock %}
{% block main %}
<link rel="stylesheet" href={{url_for("static", filename="bootstrap-icons-1.10.5/font/bootstrap-icons.css")}}>

<div class="container-fluid">
    <div class="row">
        <div class="card shadow">
            <div class="card-body">
                <div class="row bg-body-tertiary bg-white">
                    <div class="col-md-2">
                        <label for="start-date" class="form-label">请选择开始日期</label>
                        <input type="date" id="start-date" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label for="end-date" class="form-label">请选择结束日期</label>
                        <input type="date" id="end-date" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label for="job_name" class="form-label">输入作业名称</label>
                        <input type="text" id="job_name" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <label for="subject" class="form-label">学科</label>
                        <select class="form-select" id="subject">
                        
                            {% for i in sub %}
                            <option value="{{i}}">{{i}}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="class" class="form-label">请选择班级</label>
                        <select class="form-select" id="class">
                            {% for class_id, class_name in unique_classes.items() %}
                            <option value="{{ class_id }}">{{ class_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2" style="align-self: flex-end;">
                        <h3>
                            <label for="jobs" class="form-label">时段内应交作业数：</label>
                            <span id="jobs">{{jobs}}</span>
                        </h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <br>
    <!-- 以下为作业情况 -->
    <div class="row">
        <table class="table table-striped table-hover" id="table">
            <thead>
                <tr>
                    <th>序号</th>
                    <th>学号</th>
                    <th>用户名</th>
                    <th>姓名</th>
                    <th>请假次数</th>
                    <th>未交作业</th>
                    <th>作业完成率</th>
                    <th>作业得分率</th>
                    <th>查看</th>
                </tr>
            </thead>
            <tbody id="tbody">
                {% for index, row in df.iterrows() %}
                <tr >
                    <td>{{ loop.index }}</td>
                    <td>{{ row["number"] }}</td>
                    <td>{{ row["username"] }}</td>
                    <td>{{ row["name"] }}</td>
                    <td>{{ row["leave"] }}</td>
                    <td>{{ row["未交作业"] }}</td>
                    <td>
                        <div class="progress">
                            {% set rate = (jobs - row["未交作业"]) / jobs * 100 if jobs != 0 else 0 %}
                            <div class="progress-bar {% if rate > 90 %}bg-success{% elif rate > 80 %}bg-info{% elif rate > 70 %}bg-warning{% else %}bg-danger{% endif %}" role="progressbar" style="width: {{ rate }}%;" aria-valuenow="{{ rate }}" aria-valuemin="0" aria-valuemax="100">{{ rate|round(1) }}%</div>
                        </div>
                    </td>
                    <td>{{ row["平均得分率"] }}</td>
                    <td><div class="btn-group"><button type="button" class="btn btn-primary " onclick="window.location.href='/student/{{row['id']}}'">前往个人详情页</button><button type="button" class="btn btn-secondary " onclick="personal('{{row["id"]}}', '{{class_.id}}')">查看作业简况</button></div></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <br><br><br>

        <!-- 以下为bootstrap modal, 大小为800*600 -->
        <div class="modal modal-xl" tabindex="-1" id="personal-modal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="personal-modal-title">个人作业详情</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="personal-modal-body">
                        <div id="chart"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary">Save changes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/build/js/jquery.min.js"></script>
<script src={{url_for('static', filename="build/js/echarts.min.js")}}></script>

<script>
$(document).ready(function() {
    let today = new Date();
    today.setDate(today.getDate() + 1);
    let todayStr = today.toISOString().slice(0, 10);

    document.getElementById("end-date").value = todayStr;
    today.setDate(today.getDate() - 7);
    document.getElementById("start-date").value = today.toISOString().slice(0, 10);

    $('#start-date, #end-date, #job_name, #class, #subject').change(function() {
        let startDate = $('#start-date').val();
        let endDate = $('#end-date').val();
        let csrf_token = "{{ csrf_token() }}";

        $('#table').html("");
        showLoadingIndicator("#table");

        $.ajax({
            type: 'POST',
            url: '/manage/class/' + {{ class_.id }},
            headers: {
                'X-CSRFToken': csrf_token
            },
            data: {
                start: startDate,
                end: endDate,
                job_name: $('#job_name').val(),
                class_id: $('#class').val(),
                subject: $('#subject').val()
            },
            success: function(data) {
                hideLoadingIndicator("#table");
                $('#table').html($(data).find('#table').html());
                $('#jobs').html($(data).find('#jobs').html());
            },
            error: function() {
                console.log('Error retrieving data');
            }
        });
    });
});

function personal(id, class_id) {
    $('#personal-modal').modal('show');
    let csrf_token = "{{ csrf_token() }}";
    $("#chart").empty();
    showLoadingIndicator("#chart");

    $.ajax({
        type: 'POST',
        url: '/job/personal/' + id + '_' + class_id,
        headers: {
            'X-CSRFToken': csrf_token
        },
        data: {
            start: $('#start-date').val(),
            end: $('#end-date').val(),
            job_name: $('#job_name').val(),
            subject: $('#subject').val()
        },
        success: function(data) {
            hideLoadingIndicator("#chart");
            $('#personal-modal-title').html("从 " + $('#start-date').val() + ' 到 ' + $('#end-date').val());
            $("#personal-modal-body").html(data);
            let chartdiv = document.getElementById('chart');
            let line = echarts.init(chartdiv);
            line.setOption(JSON.parse(data));
            line.resize();
        },
        error: function() {
            console.log('Error retrieving data');
        }
    });
}

function showLoadingIndicator(selector) {
    $(selector).append('<div class="spinner-border text-primary" role="status"><span class="visually-hidden"></span></div>');
}

function hideLoadingIndicator(selector) {
    $(selector).find('.spinner-border').remove();
}
</script>
{% endblock %}
